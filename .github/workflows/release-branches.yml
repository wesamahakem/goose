name: Build goose release candidate

on:
  pull_request:

jobs:
  bundle-desktop:
    if: startsWith(github.head_ref, 'release/')
    uses: ./.github/workflows/bundle-desktop.yml
    permissions:
      id-token: write
      contents: read

  comment-on-pr:
    needs: bundle-desktop
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Comment with download link
        uses: peter-evans/create-or-update-comment@e8674b075228eee787fea43ef493e45ece1004c9  # v5.0.0
        with:
          issue-number: ${{ github.event.number }}
          body: |
            ### macOS ARM64 Desktop App (Apple Silicon)

            [ðŸ“± Download macOS Desktop App (arm64, unsigned)](https://nightly.link/${{ github.repository }}/actions/runs/${{ github.run_id }}/Goose-darwin-arm64.zip)

            **Instructions:**
            After downloading, unzip the file and drag the goose.app to a location you prefer. The app is unsigned, so to run it run `xattr -r -d com.apple.quarantine '/path/to/goose.app'` and then open the app

            **To test speech-to-text**, you also need to codesign the app with the microphone entitlement:
            ```
            codesign --force --deep --sign - --entitlements ui/desktop/entitlements.plist '/path/to/Goose.app'
            ```
