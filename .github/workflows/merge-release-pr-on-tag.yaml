name: Merge release PR on tag push

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+'

permissions:
  actions: write
  contents: write
  pull-requests: write
  checks: read

jobs:
  trigger-patch-release:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

    - name: Extract version from tag
      id: version
      env:
        TAG: ${{ github.ref_name }}
      run: |
        VERSION=${TAG#v}
        BRANCH="release/${VERSION}"

        echo "tag=${TAG}" >> $GITHUB_OUTPUT
        echo "version=${VERSION}" >> $GITHUB_OUTPUT
        echo "branch=${BRANCH}" >> $GITHUB_OUTPUT

        echo "Tag: ${TAG}"
        echo "Version: ${VERSION}"
        echo "Expected branch: ${BRANCH}"

    - name: Find matching PR
      id: find_pr
      env:
        GH_TOKEN: ${{ github.token }}
        BRANCH: ${{ steps.version.outputs.branch }}
      run: |
        PR_NUMBER=$(gh pr list --head "$BRANCH" --state open --json number --jq '.[0].number // empty')

        if [ -z "$PR_NUMBER" ]; then
          echo "❌ No open PR found for branch: $BRANCH"
          echo "pr_found=false" >> $GITHUB_OUTPUT
          exit 1
        else
          echo "✅ Found PR #$PR_NUMBER for branch: $BRANCH"
          echo "pr_found=true" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
        fi

    - name: Get PR details and check status
      if: steps.find_pr.outputs.pr_found == 'true'
      id: pr_status
      env:
        GH_TOKEN: ${{ github.token }}
        PR_NUMBER: ${{ steps.find_pr.outputs.pr_number }}
      run: |
        PR_DATA=$(gh pr view $PR_NUMBER --json title,headRefName,baseRefName,mergeable,statusCheckRollup)

        TITLE=$(echo "$PR_DATA" | jq -r '.title')
        HEAD_BRANCH=$(echo "$PR_DATA" | jq -r '.headRefName')
        BASE_BRANCH=$(echo "$PR_DATA" | jq -r '.baseRefName')
        MERGEABLE=$(echo "$PR_DATA" | jq -r '.mergeable')

        echo "PR Title: $TITLE"
        echo "Head Branch: $HEAD_BRANCH"
        echo "Base Branch: $BASE_BRANCH"
        echo "Mergeable: $MERGEABLE"

        if [ "$MERGEABLE" != "MERGEABLE" ]; then
          echo "❌ PR is not in a mergeable state: $MERGEABLE"
          echo "can_merge=false" >> $GITHUB_OUTPUT
          echo "merge_reason=PR is not mergeable (state: $MERGEABLE)" >> $GITHUB_OUTPUT
          exit 0
        fi

        STATUS_CHECKS=$(echo "$PR_DATA" | jq -r '.statusCheckRollup[]? | select(.conclusion != null) | "\(.context): \(.conclusion)"')
        FAILED_CHECKS=$(echo "$PR_DATA" | jq -r '.statusCheckRollup[]? | select(.conclusion == "FAILURE" or .conclusion == "CANCELLED" or .conclusion == "TIMED_OUT") | .context')
        PENDING_CHECKS=$(echo "$PR_DATA" | jq -r '.statusCheckRollup[]? | select(.conclusion == null) | .context')

        echo "Status checks:"
        if [ -n "$STATUS_CHECKS" ]; then
          echo "$STATUS_CHECKS"
        else
          echo "No status checks found"
        fi

        if [ -n "$FAILED_CHECKS" ]; then
          echo "❌ Failed checks found:"
          echo "$FAILED_CHECKS"
          echo "can_merge=false" >> $GITHUB_OUTPUT
          echo "merge_reason=Some checks are failing" >> $GITHUB_OUTPUT
          exit 0
        fi

        if [ -n "$PENDING_CHECKS" ]; then
          echo "⏳ Pending checks found:"
          echo "$PENDING_CHECKS"
          echo "can_merge=false" >> $GITHUB_OUTPUT
          echo "merge_reason=Some checks are still pending" >> $GITHUB_OUTPUT
          exit 0
        fi

        echo "✅ All checks are passing and PR is ready to merge"
        echo "can_merge=true" >> $GITHUB_OUTPUT

    - name: Get branch SHA before merge
      if: steps.find_pr.outputs.pr_found == 'true' && steps.pr_status.outputs.can_merge == 'true'
      id: branch_info
      env:
        BRANCH: ${{ steps.version.outputs.branch }}
      run: |
        git fetch origin "$BRANCH"

        BRANCH_SHA=$(git rev-parse "origin/$BRANCH")
        echo "branch_sha=$BRANCH_SHA" >> $GITHUB_OUTPUT
        echo "Branch SHA: $BRANCH_SHA"

    - name: Merge PR
      if: steps.find_pr.outputs.pr_found == 'true' && steps.pr_status.outputs.can_merge == 'true'
      env:
        GH_TOKEN: ${{ github.token }}
        PR_NUMBER: ${{ steps.find_pr.outputs.pr_number }}
        VERSION: ${{ steps.version.outputs.version }}
        TAG: ${{ steps.version.outputs.tag }}
      run: |
        gh pr merge $PR_NUMBER --squash --delete-branch --subject "Release $VERSION" --body "Auto-merged release PR after tag $TAG was pushed"

    - name: Restore branch
      if: steps.find_pr.outputs.pr_found == 'true' && steps.pr_status.outputs.can_merge == 'true'
      env:
        BRANCH: ${{ steps.version.outputs.branch }}
        BRANCH_SHA: ${{ steps.branch_info.outputs.branch_sha }}
      run: |
        git checkout -b "$BRANCH" "$BRANCH_SHA"
        git push origin "$BRANCH"

    - name: Trigger patch release
      env:
        BRANCH: ${{ steps.version.outputs.branch }}
        GH_TOKEN: ${{ github.token }}
      run: |
        gh workflow run patch-release.yaml \
          --field target_branch=$BRANCH
